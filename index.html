<!DOCTYPE html>
<html lang="vi" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng To-Do List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s ease; }
        .task-item.completed span { text-decoration: line-through; }
        .dark .task-item.completed span { color: #6b7280; }
        .task-item.completed span { color: #9ca3af; }

        /* Priority Borders */
        .task-p-high { border-left: 4px solid #ef4444; } /* red-500 */
        .task-p-medium { border-left: 4px solid #f59e0b; } /* amber-500 */
        .task-p-low { border-left: 4px solid #22c55e; } /* green-500 */

        /* Due Date Colors */
        .due-date-overdue { color: #ef4444; } /* red-500 */
        .due-date-today { color: #f97316; } /* orange-500 */

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideInUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-enter { animation: fadeIn 0.3s ease forwards; }
        .modal-leave { animation: fadeOut 0.3s ease forwards; }
        .modal-content-enter { animation: slideInUp 0.3s ease forwards; }

        @keyframes slideInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .task-item.new { animation: slideInDown 0.4s ease-out; }
        .task-item.deleting { transition: all 0.3s ease-in; opacity: 0; transform: scale(0.95); }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .pop-animation { animation: pop 0.4s ease-in-out; }
        @keyframes shake { 10%, 90% { transform: translateX(-1px); } 20%, 80% { transform: translateX(2px); } 30%, 50%, 70% { transform: translateX(-4px); } 40%, 60% { transform: translateX(4px); } }
        .shake-animation { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        .input-error { border-color: #ef4444 !important; }
        .input-error::placeholder { color: #fca5a5; }
        .edit-input { width: 100%; background-color: transparent; border: none; outline: none; padding: 0; margin: 0; font-size: inherit; color: inherit; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">

    <div class="container mx-auto max-w-lg mt-10 p-5">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 transition-colors duration-300 relative">
            
            <div class="absolute top-6 right-6 flex items-center gap-2">
                 <button id="stats-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18.7 8a.7.7 0 0 0-1.4 0v6a.7.7 0 0 0 1.4 0V8Z"/><path d="M13.7 15a.7.7 0 0 0-1.4 0v-4a.7.7 0 0 0 1.4 0v4Z"/><path d="M8.7 12a.7.7 0 0 0-1.4 0v2a.7.7 0 0 0 1.4 0v-2Z"/></svg>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600">
                    <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 10.607a1 1 0 011.414 0l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0zM1 11a1 1 0 100-2H0a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
            </div>

            <div class="flex items-center mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500 mr-3"><path d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"></path></svg>
                <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100">Danh sách công việc</h1>
            </div>

            <div id="streak-counter" class="flex items-center justify-center gap-2 mb-6 bg-orange-100 text-orange-700 dark:bg-orange-900/50 dark:text-orange-300 font-semibold p-3 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-orange-500 dark:text-orange-400"><path d="M12.001 2.003c-2.484 2.503-4.364 4.88-5.643 7.493-1.63 3.293-1.08 7.507 1.643 9.507 1.079.79 2.313 1 3.5 1 1.188 0 2.422-.21 3.501-1 2.723-2 3.273-6.214 1.643-9.507-1.279-2.613-3.159-4.99-5.644-7.493zm0 2.755c1.789 1.802 3.197 3.654 4.198 5.698.81 1.649.92 4.149-.5 5.5-1.42 1.35-3.698.419-4.198-1.25-.5-1.669.26-3.831 1.31-5.626.83-1.42 1.51-2.669 1.19-4.322-.32-1.652-2.01-1.469-2-1.469s-1.679-.183-1.999 1.469c-.32 1.653.359 2.902 1.19 4.322 1.05 1.795 1.809 3.957 1.309 5.626-.5 1.669-2.778 2.6-4.198 1.25-1.42-1.351-1.31-3.851-.5-5.5.99-2.044 2.409-3.896 4.198-5.698z"/></svg>
                <span>Chuỗi ngày hoạt động: </span><span id="streak-count">0</span>
            </div>

            <form id="todo-form" class="flex items-center gap-3 mb-2">
                <div class="relative flex-grow">
                     <input type="text" id="todo-input" placeholder="Thêm công việc hoặc mô tả dự án để AI chia nhỏ..." class="w-full p-3 pr-12 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                     <button type="button" id="gemini-btn" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-full text-purple-500 hover:bg-purple-100 dark:hover:bg-purple-900/50 transition-colors" title="Chia nhỏ công việc bằng AI">
                        <svg id="gemini-icon" class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3L9.5 8.5L4 11L9.5 13.5L12 19L14.5 13.5L20 11L14.5 8.5L12 3z"/><path d="M20 3L18.5 6L16 7L18.5 8L20 11L21.5 8L24 7L21.5 6L20 3z"/><path d="M5 16L4 18L2 18.5L4 19L5 21L6 19L8 18.5L6 18L5 16z"/></svg>
                        <svg id="gemini-spinner" class="spinner w-5 h-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                </div>
                <button type="submit" class="bg-blue-500 text-white font-semibold px-6 py-3 rounded-lg hover:bg-blue-600 transition duration-200 flex items-center gap-2">
                    Thêm
                </button>
            </form>
            
            <div class="h-6 mb-4"><p id="error-message" class="text-red-500 text-center text-sm opacity-0 transition-opacity duration-300"></p></div>

            <div id="filter-buttons" class="flex items-center justify-center gap-2 mb-6 border-b border-gray-200 dark:border-gray-700 pb-4">
                <button data-filter="all" class="filter-btn active px-4 py-2 rounded-md text-sm font-medium">Tất cả</button>
                <button data-filter="active" class="filter-btn px-4 py-2 rounded-md text-sm font-medium">Đang làm</button>
                <button data-filter="completed" class="filter-btn px-4 py-2 rounded-md text-sm font-medium">Đã hoàn thành</button>
            </div>
            
            <style>
                .filter-btn { color: #6b7280; } .dark .filter-btn { color: #9ca3af; }
                .filter-btn.active { background-color: #3b82f6; color: white; } .dark .filter-btn.active { background-color: #2563eb; }
            </style>

            <div id="todo-list" class="space-y-4"></div>
            <div id="empty-state" class="text-center py-8 hidden">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-gray-300 dark:text-gray-600 mb-4"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>
                <p class="text-gray-500 dark:text-gray-400 font-medium">Tuyệt vời! Không có công việc nào.</p>
                <p class="text-gray-400 dark:text-gray-500 text-sm">Hãy thêm một công việc mới để bắt đầu.</p>
            </div>
        </div>
    </div>
    
    <footer class="text-center text-gray-500 dark:text-gray-400 text-sm py-8">©2025 By Phan Vinh. All Right Reserved</footer>

    <!-- Stats Modal -->
    <div id="stats-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div id="stats-modal-content" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Thống kê của bạn</h2>
                <button id="stats-modal-close" class="p-1 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700">&times;</button>
            </div>
            <div class="space-y-4">
                <div class="flex justify-between p-3 bg-gray-100 dark:bg-gray-700 rounded-md">
                    <span class="font-medium text-gray-600 dark:text-gray-300">Tổng công việc hoàn thành:</span>
                    <span id="stats-completed" class="font-bold text-gray-800 dark:text-gray-100">0</span>
                </div>
                <div class="flex justify-between p-3 bg-gray-100 dark:bg-gray-700 rounded-md">
                    <span class="font-medium text-gray-600 dark:text-gray-300">Chuỗi ngày hiện tại:</span>
                    <span id="stats-current-streak" class="font-bold text-gray-800 dark:text-gray-100">0 ngày</span>
                </div>
                <div class="flex justify-between p-3 bg-gray-100 dark:bg-gray-700 rounded-md">
                    <span class="font-medium text-gray-600 dark:text-gray-300">Chuỗi ngày dài nhất:</span>
                    <span id="stats-longest-streak" class="font-bold text-gray-800 dark:text-gray-100">0 ngày</span>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-700 dark:text-gray-200 mb-2">Hoạt động 7 ngày qua</h3>
                    <div id="stats-chart" class="flex justify-between items-end gap-2 p-4 bg-gray-100 dark:bg-gray-700 rounded-md h-40">
                        <!-- Chart bars will be generated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Element Selectors ---
            const form = document.getElementById('todo-form');
            const input = document.getElementById('todo-input');
            const todoList = document.getElementById('todo-list');
            const emptyState = document.getElementById('empty-state');
            const streakCountSpan = document.getElementById('streak-count');
            const streakCounterDiv = document.getElementById('streak-counter');
            const errorMessage = document.getElementById('error-message');
            const themeToggleBtn = document.getElementById('theme-toggle');
            const lightIcon = document.getElementById('theme-toggle-light-icon');
            const darkIcon = document.getElementById('theme-toggle-dark-icon');
            const filterButtonsContainer = document.getElementById('filter-buttons');
            const statsToggleBtn = document.getElementById('stats-toggle');
            const statsModal = document.getElementById('stats-modal');
            const statsModalContent = document.getElementById('stats-modal-content');
            const statsModalCloseBtn = document.getElementById('stats-modal-close');
            const geminiBtn = document.getElementById('gemini-btn');
            const geminiIcon = document.getElementById('gemini-icon');
            const geminiSpinner = document.getElementById('gemini-spinner');

            // --- State Variables ---
            let errorTimeout;
            let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
            let streakData = JSON.parse(localStorage.getItem('streakData')) || { count: 0, lastCheckIn: null, longestStreak: 0 };
            let currentFilter = 'all';

            // --- Utility Functions ---
            const getTodayDateString = () => new Date().toISOString().split('T')[0];
            const saveTasks = () => localStorage.setItem('tasks', JSON.stringify(tasks));
            const saveStreak = () => localStorage.setItem('streakData', JSON.stringify(streakData));
            const escapeHTML = (str) => { const p = document.createElement('p'); p.textContent = str; return p.innerHTML; };

            const showError = (message) => {
                clearTimeout(errorTimeout);
                errorMessage.textContent = message;
                errorMessage.classList.remove('opacity-0');
                input.classList.add('input-error', 'shake-animation');
                errorTimeout = setTimeout(() => {
                    input.classList.remove('input-error', 'shake-animation');
                    errorMessage.classList.add('opacity-0');
                }, 3000);
            };

            // --- Gemini API Logic ---
            const handleGeminiSplit = async () => {
                const userQuery = input.value.trim();
                if (!userQuery) {
                    showError('Hãy nhập một dự án hoặc công việc lớn để AI phân tích!');
                    return;
                }

                // Show loading state
                geminiIcon.classList.add('hidden');
                geminiSpinner.classList.remove('hidden');
                geminiBtn.disabled = true;
                form.querySelector('button[type="submit"]').disabled = true;
                input.disabled = true;

                try {
                    const apiKey = ""; // Canvas provides the key
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    const systemPrompt = "Bạn là một trợ lý quản lý dự án xuất sắc. Khi nhận được một công việc hoặc dự án lớn, hãy chia nhỏ nó thành các công việc con cụ thể, có thể hành động ngay. Chỉ trả về một đối tượng JSON có chứa một mảng các chuỗi ký tự (string) với key là 'tasks'.";

                    const payload = {
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: { "tasks": { "type": "ARRAY", "items": { "type": "STRING" } } }
                            }
                        }
                    };
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (jsonText) {
                        const parsedJson = JSON.parse(jsonText);
                        const subtasks = parsedJson.tasks || [];
                        if (subtasks.length > 0) {
                            subtasks.reverse().forEach(taskText => {
                                tasks.unshift({ 
                                    id: Date.now(), text: taskText, completed: false, 
                                    priority: 'medium', dueDate: null, completionDate: null 
                                });
                            });
                            saveTasks();
                            renderTasks();
                            input.value = '';
                            updateStreak();
                        } else {
                            showError("AI không thể chia nhỏ công việc này. Hãy thử lại với mô tả khác.");
                        }
                    } else {
                         throw new Error("Phản hồi từ AI không hợp lệ.");
                    }

                } catch (error) {
                    console.error('Gemini API call failed:', error);
                    showError("Đã có lỗi xảy ra với trợ lý AI. Vui lòng thử lại sau.");
                } finally {
                    // Hide loading state
                    geminiIcon.classList.remove('hidden');
                    geminiSpinner.classList.add('hidden');
                    geminiBtn.disabled = false;
                    form.querySelector('button[type="submit"]').disabled = false;
                    input.disabled = false;
                }
            };
            geminiBtn.addEventListener('click', handleGeminiSplit);


            // --- Dark Mode Logic ---
            const updateThemeIcons = () => {
                if (document.documentElement.classList.contains('dark')) {
                    lightIcon.classList.add('hidden'); darkIcon.classList.remove('hidden');
                } else {
                    lightIcon.classList.remove('hidden'); darkIcon.classList.add('hidden');
                }
            };
            themeToggleBtn.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
                updateThemeIcons();
            });

            // --- Streak Logic ---
            const renderStreak = () => { streakCountSpan.textContent = streakData.count; };
            const triggerStreakAnimation = () => {
                streakCounterDiv.classList.remove('pop-animation');
                void streakCounterDiv.offsetWidth;
                streakCounterDiv.classList.add('pop-animation');
                streakCounterDiv.addEventListener('animationend', () => streakCounterDiv.classList.remove('pop-animation'), { once: true });
            };
            const updateStreak = () => {
                const today = getTodayDateString();
                if (streakData.lastCheckIn !== today) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split('T')[0];
                    streakData.count = streakData.lastCheckIn === yesterdayStr ? streakData.count + 1 : 1;
                    if (streakData.count > (streakData.longestStreak || 0)) {
                        streakData.longestStreak = streakData.count;
                    }
                    streakData.lastCheckIn = today;
                    saveStreak();
                    renderStreak();
                    triggerStreakAnimation();
                }
            };
            const checkStreakOnLoad = () => {
                if (!streakData.lastCheckIn) return;
                const today = getTodayDateString();
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                if (streakData.lastCheckIn !== today && streakData.lastCheckIn !== yesterday.toISOString().split('T')[0]) {
                    streakData.count = 0;
                    saveStreak();
                }
            };
            
            // --- Task Rendering Logic ---
            const renderTasks = () => {
                let filteredTasks = tasks;
                if (currentFilter === 'active') filteredTasks = tasks.filter(t => !t.completed);
                else if (currentFilter === 'completed') filteredTasks = tasks.filter(t => t.completed);

                todoList.innerHTML = '';
                emptyState.classList.toggle('hidden', filteredTasks.length > 0);

                filteredTasks.forEach(task => {
                    const taskItem = document.createElement('div');
                    const priorityClass = `task-p-${task.priority || 'medium'}`;
                    taskItem.className = `task-item flex items-center justify-between p-3 pl-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border-l-4 dark:border-gray-700 transition-all duration-300 ${task.completed ? 'completed' : ''} ${priorityClass}`;
                    taskItem.dataset.id = task.id;

                    // Due date logic
                    let dueDateHTML = '';
                    if (task.dueDate) {
                        const today = new Date(getTodayDateString());
                        const dueDate = new Date(task.dueDate);
                        let dateClass = 'text-gray-400 dark:text-gray-500';
                        if (dueDate < today) dateClass = 'due-date-overdue';
                        else if (dueDate.getTime() === today.getTime()) dateClass = 'due-date-today';
                        dueDateHTML = `<span class="due-date text-xs font-medium ${dateClass}">${task.dueDate}</span>`;
                    }

                    taskItem.innerHTML = `
                        <div class="flex items-center gap-3 flex-grow min-w-0">
                            <input type="checkbox" ${task.completed ? 'checked' : ''} class="w-5 h-5 text-blue-500 rounded border-gray-300 dark:border-gray-500 focus:ring-blue-500 dark:bg-gray-600 cursor-pointer flex-shrink-0">
                            <div class="flex-grow">
                                <span class="text-gray-700 dark:text-gray-200" data-action="edit">${escapeHTML(task.text)}</span>
                                ${dueDateHTML}
                            </div>
                        </div>
                        <div class="flex items-center gap-2 ml-2 flex-shrink-0">
                            <button class="task-action-btn" data-action="priority">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" class="${priorityClass === 'task-p-high' ? 'text-red-500' : (priorityClass === 'task-p-medium' ? 'text-amber-500' : 'text-green-500')}"><path d="M14.4 6 14 4H5v17h2v-7h5.6l.4 2h7V6z"/></svg>
                            </button>
                             <button class="task-action-btn relative" data-action="date">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-400 hover:text-blue-500"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                <input type="date" class="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer" data-action="date-input" value="${task.dueDate || ''}"/>
                            </button>
                            <button class="delete-btn text-gray-400 hover:text-red-500 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6m4-6v6"/></svg>
                            </button>
                        </div>
                    `;
                    todoList.appendChild(taskItem);
                });
            };
            
            // --- Event Listeners ---
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                if (input.value.trim()) {
                    tasks.unshift({ 
                        id: Date.now(), text: input.value.trim(), completed: false, 
                        priority: 'medium', dueDate: null, completionDate: null 
                    });
                    saveTasks(); renderTasks();
                    const firstTaskElement = todoList.querySelector('.task-item');
                    if (firstTaskElement) firstTaskElement.classList.add('new');
                    input.value = ''; updateStreak();
                } else {
                    showError('Hãy viết gì đó trước đã!');
                }
            });

            todoList.addEventListener('click', (e) => {
                const taskItem = e.target.closest('.task-item');
                if (!taskItem) return;
                const taskId = Number(taskItem.dataset.id);
                const task = tasks.find(t => t.id === taskId);
                if (!task) return;

                if (e.target.type === 'checkbox') {
                    task.completed = e.target.checked;
                    task.completionDate = task.completed ? getTodayDateString() : null;
                    if (task.completed) updateStreak();
                    saveTasks(); renderTasks();
                } else if (e.target.closest('.delete-btn')) {
                    taskItem.classList.add('deleting');
                    setTimeout(() => { tasks = tasks.filter(t => t.id !== taskId); saveTasks(); renderTasks(); }, 300);
                } else if (e.target.closest('[data-action="priority"]')) {
                    const priorities = ['medium', 'high', 'low'];
                    const currentPriorityIndex = priorities.indexOf(task.priority || 'medium');
                    task.priority = priorities[(currentPriorityIndex + 1) % priorities.length];
                    saveTasks(); renderTasks();
                }
            });
            
            todoList.addEventListener('change', (e) => {
                 if (e.target.matches('[data-action="date-input"]')) {
                    const taskItem = e.target.closest('.task-item');
                    const taskId = Number(taskItem.dataset.id);
                    const task = tasks.find(t => t.id === taskId);
                    if (task) {
                        task.dueDate = e.target.value || null;
                        saveTasks();
                        renderTasks();
                    }
                }
            });

            todoList.addEventListener('dblclick', (e) => {
                if (e.target.dataset.action === 'edit') {
                    const taskSpan = e.target;
                    const taskItem = taskSpan.closest('.task-item');
                    const taskId = Number(taskItem.dataset.id);
                    const task = tasks.find(t => t.id === taskId);
                    const input = document.createElement('input');
                    input.type = 'text'; input.value = task.text; input.className = 'edit-input';
                    taskSpan.parentElement.replaceChild(input, taskSpan);
                    input.focus();
                    input.select();
                    const saveEdit = () => { if (input.value.trim()) task.text = input.value.trim(); saveTasks(); renderTasks(); };
                    input.addEventListener('blur', saveEdit);
                    input.addEventListener('keydown', (e) => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') renderTasks(); });
                }
            });

            filterButtonsContainer.addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON') {
                    currentFilter = e.target.dataset.filter;
                    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    renderTasks();
                }
            });

            // --- Stats Modal Logic ---
            const renderStats = () => {
                document.getElementById('stats-completed').textContent = tasks.filter(t => t.completed).length;
                document.getElementById('stats-current-streak').textContent = `${streakData.count} ngày`;
                document.getElementById('stats-longest-streak').textContent = `${streakData.longestStreak || 0} ngày`;
                
                // Chart
                const chart = document.getElementById('stats-chart');
                chart.innerHTML = '';
                const weeklyData = [];
                for(let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateString = date.toISOString().split('T')[0];
                    const day = date.toLocaleDateString('vi-VN', { weekday: 'short' });
                    const count = tasks.filter(t => t.completionDate === dateString).length;
                    weeklyData.push({ day, count });
                }
                const maxCount = Math.max(...weeklyData.map(d => d.count), 1);
                weeklyData.forEach(data => {
                    const barHeight = (data.count / maxCount * 100) + '%';
                    const bar = `
                        <div class="flex flex-col items-center justify-end h-full w-full">
                            <div class="text-xs font-bold text-gray-700 dark:text-gray-200">${data.count}</div>
                            <div class="w-3/4 bg-blue-300 dark:bg-blue-600 rounded-t-sm" style="height: ${barHeight}"></div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">${data.day}</div>
                        </div>`;
                    chart.innerHTML += bar;
                });
            };

            statsToggleBtn.addEventListener('click', () => {
                renderStats();
                statsModal.classList.remove('hidden');
                statsModal.classList.add('modal-enter');
                statsModalContent.classList.add('modal-content-enter');
            });
            statsModalCloseBtn.addEventListener('click', () => {
                statsModal.classList.add('modal-leave');
                setTimeout(() => {
                    statsModal.classList.add('hidden');
                    statsModal.classList.remove('modal-enter', 'modal-leave');
                    statsModalContent.classList.remove('modal-content-enter');
                }, 300);
            });
            statsModal.addEventListener('click', (e) => { if(e.target === statsModal) statsModalCloseBtn.click() });

            // --- App Initialization ---
            updateThemeIcons();
            checkStreakOnLoad();
            renderStreak();
            renderTasks();
        });
    </script>
</body>
</html>

